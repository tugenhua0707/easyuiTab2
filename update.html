<!DOCTYPE html>
<html>
  <head>
    <title>tab演示</title>
    <link href="./libs/easyui/themes/default/easyui.css" rel="stylesheet" />
    <link href="./libs/easyui/themes/icon.css" rel="stylesheet" />
    <link href="./libs/kindeditor/themes/default/default.css" rel="stylesheet" />

    <script src="./libs/jquery-1.11.0.min.js"></script>
    <script src='./libs/easyui/jquery.easyui.min.js'></script>
    <script type="text/javascript" src="./libs/kindeditor/kindeditor-all.js"></script>
    <script type="text/javascript" src="./libs/kindeditor/lang/zh_CN.js"></script>

    <style>
      .hidden {
        display: none;
      }
      .tabs-wrap {
        position: relative;
      }
      .arrow_icon,.arrow_icon.up {
        position: absolute;
        top: 4px;
        right: 10px;
        background: url(./images/fold.png) no-repeat;
        width: 18px;
        height: 18px;
        cursor: pointer;
        z-index: 10;
      }
      .arrow_icon.up {
        background-position: -14px 3px;
        top: 2px;
      }
      #containerId .tabs li a.tabs-inner {
        padding: 0 14px;
      }
      #containerId .tabs-panels {
        position: relative;
      }
      #containerId .editcls {
        display: none;
      }
      #containerId .mask {
        display: block;
        position: absolute;
        top: 0;
        right: 0;
        background: #000;
        width: 100%;
        height: 100%;
        opacity: 0.5;
        color: #fff;
        text-align: right;
        padding-right: 20px;
        padding-top: 20px;
        cursor: pointer;
      }
    </style>
    <script type="text/javascript" src="./js/tabs.js"></script>
  </head>
  <body>
    <h2>编辑页面</h2>
    <div id="tabContent" style="display: none;">
      <form>
        <div class="content">
          <p>
            <label>标题：</label>
            <input name="title" type="text"/>
          </p>
          <p>
            <label>类型：</label>
            <select name="type" style="width:100px;height:24px;">
              <option value="1">女人</option>
              <option value="2">金钱</option>
              <option value="3">地位</option>
              <option value="4">权利</option>
            </select>
          </p>
        </div>
        <textarea name="editorName" style="width:700px;height:300px;"></textarea>
      </form>
    </div>
    <div>
    <span id="j-submit">提交</span></div>
    <div id="containerId" style="width: 800px;"></div>
    <script>  
      // 假如返回的json数据如下：
      var data = {
        num: '2',
        list: [
          {
            "id": 123,
            "customRouteId": 0,
            "operateType": 0,
            "title": '标题1',
            "type": 1,
            "index": 1,
            "content": '123456'
          },
          {
            "id": 123,
            "customRouteId": 0,
            "operateType": 0,
            "title": '标题2',
            "type": 2,
            "index": 1,
            "content": '654321'
          }
        ]
      };
      var $panel = new AddTabs({
        value: data.num,
        sameTabContent: 'tabContent',
        container: '#containerId',
        initTabCallBack: function($this, title, index) {
          var panels = $this.find('.tabs-panels .panel').eq(index);
          var $formElems = $(panels).find('form').serializeArray();
          // 设置form元素的属性
          setFormElems(panels, $formElems, title);

          // 设置operateType属性
          $(panels).attr("data-operateType", data.list[index].operateType);

          // 设置编辑的值
          setEditValue(panels, $formElems, title);

          // 渲染富文本编辑器
          renderKindeditor(panels, title);

          // 设置编辑器内容
          setKindeditorValue(panels, title);

          // 添加模板
          if ($(panels).find('.mask').length < 1) {
            $(panels).append('<div class="editcls mask">编辑</div>');
          }
          
        }
      });
      // 设置form元素的name属性 
      function setFormElems($panel, $formElems, title) {
        if ($formElems && $formElems.length) {
          for (var i = 0, ilen = $formElems.length; i < ilen; i++) {
            var name = $formElems[i].name;
            var newAttrName = name + title;
            if ($($panel).find('input[name="'+name+'"]')) {
              $($panel).find('input[name="'+name+'"]').attr("name", newAttrName);
            }
            if ($($panel).find('select[name="'+name+'"]')) {
              $($panel).find('select[name="'+name+'"]').attr('name', newAttrName);
            }
            if ($($panel).find('textarea[name="'+name+'"]')) {
              $($panel).find('textarea[name="'+name+'"]').attr('name', newAttrName);
            }
          }
        }
      }
      // 设置编辑页面的值
      function setEditValue($panel, $formElems, index) {
        if ($formElems && $formElems.length) {
          if (data.list && data.list.length) {
            var item = data.list[index - 1];
            for (var i = 0, ilen = $formElems.length; i < ilen; i++) {
              var name = $formElems[i].name;
              var newAttrName = name + index;
              if ($($panel).find('input[name="'+newAttrName+'"]').length) {
                $($panel).find('input[name="'+newAttrName+'"]').val(item[name]);
              }
              if ($($panel).find('select[name="'+newAttrName+'"]').length) {
                $($panel).find('select[name="'+newAttrName+'"]').val(item[name]);
              }
              if ($($panel).find('textarea[name="'+newAttrName+'"]').length) {
                $($panel).find('textarea[name="'+newAttrName+'"]').val(item[name]);
              }
            }
          } else {
            throw new Error('列表数据为空');
          }
        }
      }
      function renderKindeditor($panel, title) {
        var editorElem = $('textarea[name="editorName'+title+'"]').eq(0);
        KindEditor.create(editorElem, {
          items: [
            'source', 'fontname', 'forecolor', 'fontsize', 'hilitecolor', 'bold', 'italic', 'underline' ,'hr',
            '|', 'emoticons', 'justifyleft', 'justifycenter', 'justifyright','insertorderedlist','insertunorderedlist','justifyfull', 'multiimage2','link', 'fullscreen', 'iphone'
          ],
          // uploadJson: '',  // 该配置是上传图片的地址
          pasteType: 1,      // 0 禁止黏贴 1 是纯文本黏贴 2 是html黏贴
          minHeight: 375
        });
      }
      function setKindeditorValue($panel, index) {
        var editorElem = $('textarea[name="editorName'+index+'"]').eq(0);
        if (data.list && data.list.length) {
          var value = data.list[index - 1].content;
          KindEditor.html(editorElem, value);
        }
      }
      $("#containerId").on('click', '.editcls', function(){
        var $this = $(this);
        $this.closest('.panel').attr('data-operateType', 2);
        $this.removeClass('mask');
      });
      $('#j-submit').click(function(){
        var newArrs = [];
        var tabs = $("#containerId .easyui-tabs .panel");
        $(tabs).each(function(index, item){
          var curIndex = index + 1;
          var title = $(item).find('input[name="title'+curIndex+'"]').val();
          var type = $(item).find('select[name="type'+curIndex+'"]').val();
          var editorDOM = $('textarea[name="editorName'+curIndex+'"]').eq(0);
          var operateType = $(item).attr("data-operateType");
          KindEditor.sync(editorDOM);
          var editorName = editorDOM.val();
          newArrs.push({
            "title": title,
            "type": type,
            "editorName": editorName,
            "index": curIndex,
            "operateType": operateType
          });
        });
        console.log(newArrs);
      });
    </script>
  </body>
</html>